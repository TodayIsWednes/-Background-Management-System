<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>设置权限 - 光年(Light Year Admin)后台管理系统模板</title>
    <link rel="icon" th:href="@{/favicon.ico}" type="image/ico">
    <meta name="keywords" content="LightYear,光年,后台模板,后台管理系统,光年HTML模板">
    <meta name="description" content="LightYear是一个基于Bootstrap v3.3.7的后台管理系统的HTML模板。">
    <meta name="author" content="yinqi">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/materialdesignicons.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.min.css}" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/10.12.4/sweetalert2.min.css" rel="stylesheet"/>

</head>

<body>
<div class="lyear-layout-web">
    <div class="lyear-layout-container">
        <!--左侧导航-->
        <div  th:include="left_nav::left_nav"></div>
        <!--End 左侧导航-->

        <!--头部信息-->

        <!--End 头部信息-->
        <div  th:include="header::header"></div>
        <!--页面主要内容-->
        <main class="lyear-layout-content">

                <div class="container-fluid">

                    <div class="row">
                        <div class="col-lg-10">


                            <div class="card">
                                <div class="card-header"><h4>用户修改</h4></div>
                                <div class="card-body">

                                    <form action="#!" method="post">
                                        <div class="form-group">

                                            <label for="user-name">用户名</label>
                                            <input class="form-control" type="text" id="user-name" name="role-name" th:placeholder="${user.userName}">

                                            <label for="user-repassword">修改密码</label>
                                            <input class="form-control" type="password" id="user-repassword" name="role-repassword" >
                                            <label for="user-createtime">创建时间</label>
                                            <input class="form-control" type="disable" id="user-createtime" name="role-createtime" th:value="${user.createTime}">

                                            <label for="user-updatetime">更新时间</label>
                                            <input class="form-control" type="disable" id="user-updatetime" name="role-repassword" th:value="${user.updateTime}">

                                        </div>
                                        <div>

                                            <div class="table-responsive">
                                                <label >角色列表</label>
                                                <div class="example-box">

                                                    <input type="hidden" id="user-id" th:value="${user.id}"></div>
                                                    <button type="button" class="btn btn-w-md btn-sm btn-round btn-primary" id="role-add-btn" data-toggle="modal" data-target="#exampleModal" data-whatever="@mdo"><label><i class="mdi mdi-account-multiple-plus"></i></label>添加角色</button>
                                                    <button type="button" class="btn btn-w-md btn-sm btn-round btn-danger" id="role-delete-btn"><label><i class="mdi mdi-account-off"></i></label>删除角色</button>
                                                </div>
                                                <table class="table table-bordered">
                                                    <thead>
                                                    <tr>
                                                        <th>
                                                            <label class="lyear-checkbox checkbox-primary">
                                                                <input type="checkbox" id="check-all"><span></span>
                                                            </label>
                                                        </th>
                                                        <th>编号</th>
                                                        <th>角色名</th>
                                                        <th>描述</th>
                                                        <th>状态</th>
                                                        <th>创建时间</th>
                                                        <th>更新时间</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>

                                                    <tr th:each=" role, roleStat : ${roleList}">
                                                        <td>
                                                            <label class="lyear-checkbox checkbox-primary">
                                                                <input type="checkbox" name="ids[]" class="ids" th:value="${role.id}"><span></span>
                                                            </label>
                                                        </td>
                                                        <td th:text="${role.id}"></td>
                                                        <td th:text="${role.roleName}"></td>
                                                        <td th:text="${role.description}"></td>
                                                        <td  class="text-success" th:text="${role.status}"></td>
                                                        <td th:text="${role.addTime}"></td>
                                                        <td th:text="${role.updateTime}"></td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </div>



                                    </form>

                                </div>
                            </div>


                            <div class="row">
                                <div class="col-lg-12">

                                    <div class="card">
                                        <div class="card-header"><h4>操作</h4></div>
                                        <div class="card-body">
                                            <div class="example-box">
                                                <button id="user-modify-btn" class="btn btn-label btn-primary"><label><i class="mdi mdi-checkbox-marked-circle-outline"></i></label> 确认提交</button>
                                                <button class="btn btn-label btn-warning"><label><i class="mdi mdi-delete-empty"></i></label> 清空数据</button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>
                </div>


        </main>

        <!--End 页面主要内容-->
    </div>
</div>


<!-----------------------------------------------模态框--------------------------------------------------->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">为用户添加角色</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="role-multiple-select" class="control-label">角色列表：</label>
                        <select class="form-control" id="role-multiple-select" name="example-multiple-select" size="7" multiple>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" id="role-choose-role-btn" class="btn btn-primary">发送消息</button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript" th:src="@{/js/jquery.min.js}"></script>
<script type="text/javascript" th:src="@{/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/js/perfect-scrollbar.min.js}"></script>
<script type="text/javascript" th:src="@{/js/main.min.js}"></script>
<script type="text/javascript" th:src="@{/js/chosen.jquery.min.js}"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/10.12.4/sweetalert2.min.js"></script>

<script>

   function getSelectedCheckBox(className){
       inputArray=new Array();
        $("input[class='"+className+"']:checked").each(function(index,elements){
           inputArray.push($(this).val());
       })
       return inputArray;
   }

   function isEmpty(str){
       if(str==""||str==null||str==undefined){
           return true;
       }else{
           return false;
       }
   }

   $(document).ready(function(){
       $("#role-delete-btn").click(function(){
           var intputArray=getSelectedCheckBox("ids");

           var userid=$("input[type=hidden]").val();
           var jsonStr = JSON.stringify(intputArray);

           if(intputArray==null||intputArray.length<=0){
               Swal.fire("哦豁", "请选中角色", "info");
           }else{


               Swal.fire({
                   type: 'warning', // 弹框类型
                   title: '删除角色', //标题
                   text: "删除后将无法恢复，请谨慎操作！", //显示内容

                   confirmButtonColor: '#3085d6',// 确定按钮的 颜色
                   confirmButtonText: '确定',// 确定按钮的 文字
                   showCancelButton: true, // 是否显示取消按钮
                   cancelButtonColor: '#d33', // 取消按钮的 颜色
                   cancelButtonText: "取消", // 取消按钮的 文字

                   focusCancel: true, // 是否聚焦 取消按钮
                   reverseButtons: true  // 是否 反转 两个按钮的位置 默认是  左边 确定  右边 取消
               }).then((isConfirm) => {
                   try {
                       //判断 是否 点击的 确定按钮
                       if (isConfirm.value) {
                           Swal.fire("成功", "点击了确定", "success");
                           //发送请求 删除角色 删除成功后刷新页面
                           $.ajax({
                               type:"post",
                               url:"/user/deleteRelation",
                               dataType:"json",
                               data:{
                                   userId:userid,
                                   data:jsonStr
                               },
                               success:function(data){
                                   window.location.reload();
                               },
                               error:function(){
                                   Swal.fire("哦豁", "出现网络错误，请联系管理员", "error");
                               }
                           })
                       }
                       else {
                           Swal.fire("取消", "点击了取消", "error");
                       }
                   } catch (e) {
                       alert(e);
                   }
               });

           }

       })

       $("#role-add-btn").click(function () {
           //获取所有的角色
           $.ajax({
               method:"get",
               url:"/role/getAllRoles",
               dataType:"json",
               success:function(data){
                   var roleArray=data.data;
                   if(roleArray!=null){
                       for(i=0;i<roleArray.length;i++){
                           $("#role-multiple-select").append("<option value='"+roleArray[i].id+"'>"+roleArray[i].roleName+"</option>");
                       }
                   }
               },
               error:function (data) {
                   Swal.fire("哦豁", "出现网络错误，请联系管理员", "error");
               }
           })

       });

       $("#role-choose-role-btn").click(function(){

           var userId=$("input[type=hidden]").val();
           var roleId=$("#role-multiple-select").get(0).value;
           //发送请求 为用户添加角色
           $.ajax({
               method:'post',
               url:'/user/addRoleForUser',
               dataType:'json',
               data:{
                   userId:userId,
                   roleId:roleId
               },
               success:function(data){
                   if(data.status==200||data.status=="200"){
                       $('#exampleModal').modal('hide');
                       Swal.fire("成功", "添加了角色", "success");
                       setTimeout("window.location.reload();",1500);
                   }


                   //window.location.reload();
               },
               error:function(data){
                   Swal.fire("哦豁", "出现网络错误，请联系管理员", "error");
               }
           })


       })

       $("#user-modify-btn").click(function(){
           //获取用户填写表单信息
           var rePassword=$("#user-repassword").val();
           var userName=$("#user-name").val();
           var userId=$("#user-id").val();
           //1.不为空提交
           if(!isEmpty(rePassword)&&!isEmpty(userName)&&!isEmpty(userId)){
               $.ajax({
                   method:"post",
                   url:"/user/update",
                   dataType:"json",
                   data:{
                       userId:userId,
                       userName:userName,
                       rePassword:rePassword,
                   },
                   success:function(data){

                   },
                   error:function(data){

                   }
               })
           }else{//2.为空提示
               Swal.fire("哦豁", "请把表单信息填写完整后在提交！", "error");
           }


       });
    });

</script>

</body>
</html>